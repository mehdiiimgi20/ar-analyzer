<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحلیل گر پیشرفته AR زیما</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0f3460;
            --light-gray: #f5f5f5;
            --border-color: #e0e0e0;
            --text-color: #333;
            --white-color: #ffffff;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --error-color: #c0392b;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl;
            background-color: var(--light-gray);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background-color: var(--white-color);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }

        header h1 {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.8rem;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-color);
        }
        
        .btn:disabled {
            background-color: #a0b0c8;
            color: #e0e0e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .upload-icon {
            font-size: 1.3rem;
            transform: translateY(2px);
        }

        .file-input { display: none; }

        .preview-container {
            margin-top: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        .preview-card {
            position: relative;
            animation: fadeIn 0.4s;
        }

        .preview-card img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid var(--border-color);
        }
        
        .preview-card .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--primary-color);
            color: var(--white-color);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            font-size: 0.9rem;
            border: 2px solid var(--white-color);
        }

        .action-buttons {
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .status-box {
            text-align: center;
            padding: 12px;
            margin-top: 25px;
            border-radius: 12px;
            font-weight: 700;
        }
        
        .status-box.error {
            background-color: #fbe9e7;
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }
        
        .results-container { margin-top: 25px; }

        .recommendation-card {
            background: linear-gradient(45deg, var(--primary-color), #2c3e50);
            color: var(--white-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            animation: fadeIn 0.5s;
        }
        .recommendation-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.3rem;
        }
        .recommendation-card img {
            max-width: 80%;
            max-height: 200px;
            border-radius: 12px;
            border: 3px solid var(--white-color);
            margin-bottom: 15px;
        }
        .recommendation-card .filename {
            font-weight: 700;
            font-size: 1.1rem;
        }
        .recommendation-card .quality-text {
            font-size: 1rem;
            opacity: 0.9;
        }
        .recommendation-card .quality-text span {
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .result-card {
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .result-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .result-header img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .result-title { flex-grow: 1; }
        .result-title .filename {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .verdict {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            color: var(--white-color);
        }
        .verdict.good { background-color: var(--success-color); }
        .verdict.bad { background-color: var(--error-color); }

        .quality-percent {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .analysis-body {
            padding-top: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .analysis-list h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .analysis-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .analysis-list li {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .strengths h4 { color: var(--success-color); }
        .weaknesses h4 { color: var(--error-color); }
        
        .icon-check::before { content: '✔'; color: var(--success-color); }
        .icon-cross::before { content: '✖'; color: var(--error-color); }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>تحلیل گر AR زیما</h1>
        </header>
        <main>
            <input type="file" id="file-input" class="file-input" multiple accept="image/*">
            <button class="btn btn-primary" id="upload-btn">
                <span class="upload-icon">↑</span>
                <span>انتخاب عکس‌ها (چندتایی)</span>
            </button>

            <div class="preview-container" id="preview-container"></div>
            <div id="status-box" class="status-box error" style="display: none;"></div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="analyze-btn" disabled>تحلیل اولیه (پیشنهاد هوشمند)</button>
                <button class="btn btn-secondary" id="mindar-btn" disabled>تحلیل نتیجه تست MindAR</button>
            </div>
            
            <div class="results-container" id="results-container"></div>
        </main>
    </div>

    <script async src="https://docs.opencv.org/4.9.0/opencv.js" onload="onOpenCvReady();"></script>
    
    <script type="text/javascript">
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const analyzeBtn = document.getElementById('analyze-btn');
    const previewContainer = document.getElementById('preview-container');
    const resultsContainer = document.getElementById('results-container');
    const statusBox = document.getElementById('status-box');

    let selectedFiles = [];

    function onOpenCvReady() {
        console.log("OpenCV is ready.");
    }

    uploadBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (event) => {
        selectedFiles = Array.from(event.target.files);
        previewContainer.innerHTML = '';
        resultsContainer.innerHTML = '';
        statusBox.style.display = 'none';
        
        if (selectedFiles.length > 0) {
            analyzeBtn.disabled = false;
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const card = document.createElement('div');
                    card.className = 'preview-card';
                    card.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <div class="badge">${index + 1}</div>
                    `;
                    previewContainer.appendChild(card);
                };
                reader.readAsDataURL(file);
            });
        } else {
            analyzeBtn.disabled = true;
        }
    });

    analyzeBtn.addEventListener('click', async () => {
        if (selectedFiles.length === 0) return;

        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'در حال تحلیل...';
        resultsContainer.innerHTML = '';

        let analysisResults = [];
        for (const file of selectedFiles) {
            try {
                const result = await analyzeImageWithOpenCV(file);
                analysisResults.push(result);
            } catch (err) {
                console.error("Error analyzing file:", file.name, err);
                analysisResults.push({
                    filename: file.name,
                    report: generateAnalysisReport({}),
                    imgSrc: URL.createObjectURL(file)
                });
            }
        }
        
        analysisResults.sort((a, b) => b.report.quality - a.report.quality);
        displayResults(analysisResults);
        
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'تحلیل اولیه (پیشنهاد هوشمند)';
    });

    function analyzeImageWithOpenCV(file) {
        return new Promise((resolve, reject) => {
            if (typeof cv === 'undefined' || !cv.imread) {
                 statusBox.textContent = 'خطا: موتور پردازش تصویر (OpenCV) بارگذاری نشده است.';
                 statusBox.style.display = 'block';
                 return reject('OpenCV not ready');
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const imgElement = document.createElement('img');
                imgElement.src = e.target.result;
                imgElement.onload = () => {
                    try {
                        let src = cv.imread(imgElement);
                        let gray = new cv.Mat();
                        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
                        
                        let keypoints = new cv.KeyPointVector();
                        let orb = new cv.ORB(2000);
                        orb.detect(gray, keypoints);
                        const featureScore = keypoints.size();

                        let mean = new cv.Mat();
                        let stdDev = new cv.Mat();

                        cv.meanStdDev(gray, mean, stdDev);
                        const contrastScore = stdDev.data64F[0];

                        let laplacian = new cv.Mat();
                        cv.Laplacian(gray, laplacian, cv.CV_64F, 1, 1, 0, cv.BORDER_DEFAULT);
                        cv.meanStdDev(laplacian, mean, stdDev);
                        const sharpnessScore = Math.pow(stdDev.data64F[0], 2);

                        const report = generateAnalysisReport({ featureScore, contrastScore, sharpnessScore });

                        src.delete(); gray.delete(); keypoints.delete(); orb.delete(); mean.delete(); stdDev.delete(); laplacian.delete();
                        
                        resolve({ filename: file.name, report, imgSrc: e.target.result });
                    } catch (err) {
                        reject(err);
                    }
                };
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function generateAnalysisReport(metrics) {
        const { featureScore = 0, contrastScore = 0, sharpnessScore = 0 } = metrics;
        const strengths = [];
        const weaknesses = [];

        const featurePercent = Math.min(featureScore / 1500, 1) * 100;
        const contrastPercent = Math.min(contrastScore / 50, 1) * 100;
        const sharpnessPercent = Math.min(sharpnessScore / 150, 1) * 100;
        
        if (featurePercent > 70) strengths.push("جزئیات و نقاط قابل ردیابی بسیار زیاد است");
        else if (featurePercent > 40) strengths.push("جزئیات کافی برای ردیابی دارد");
        else weaknesses.push("فاقد جزئیات کافی و نقاط قابل ردیابی است");

        if (contrastPercent > 60) strengths.push("کنتراست بالا و وضوح رنگ عالی");
        else if (contrastPercent < 30) weaknesses.push("کنتراست پایین، تشخیص لبه‌ها دشوار است");
        
        if (sharpnessPercent > 50) strengths.push("تصویر واضح و بدون تاری است");
        else if (sharpnessPercent < 20) weaknesses.push("تصویر تار است و جزئیات محو شده‌اند");

        if (featurePercent < 50 && contrastPercent < 50) {
            weaknesses.push("مناطق بزرگ و یکنواخت در تصویر وجود دارد");
        }

        const quality = (featurePercent * 0.6) + (contrastPercent * 0.2) + (sharpnessPercent * 0.2);
        const isGood = quality > 55 && featurePercent > 35;

        return {
            quality: Math.round(quality),
            verdict: isGood ? "مناسب" : "نامناسب",
            strengths,
            weaknesses
        };
    }

    function displayResults(results) {
        resultsContainer.innerHTML = ''; // Clear previous results

        if (results.length === 0) return;

        // --- NEW: Create and display the final recommendation card ---
        const bestResult = results[0];
        if (bestResult.report.verdict === 'مناسب') {
            const recommendationCard = document.createElement('div');
            recommendationCard.className = 'recommendation-card';
            recommendationCard.innerHTML = `
                <h3>⭐ پیشنهاد نهایی</h3>
                <img src="${bestResult.imgSrc}" alt="${bestResult.filename}">
                <p class="filename">${bestResult.filename}</p>
                <p class="quality-text">
                    این عکس با کیفیت <span>${bestResult.report.quality}%</span> بهترین گزینه برای پروژه شماست.
                </p>
            `;
            resultsContainer.appendChild(recommendationCard);
        }


        // --- Display detailed analysis for all images ---
        const detailsHeader = document.createElement('h3');
        detailsHeader.textContent = 'تحلیل دقیق عکس‌ها';
        detailsHeader.style.textAlign = 'center';
        detailsHeader.style.marginBottom = '15px';
        detailsHeader.style.color = 'var(--primary-color)';
        resultsContainer.appendChild(detailsHeader);

        results.forEach(result => {
            const card = document.createElement('div');
            card.className = 'result-card';
            const { report, imgSrc, filename } = result;
            
            const verdictClass = report.verdict === "مناسب" ? "good" : "bad";

            let strengthsHTML = report.strengths.map(s => `<li><span class="icon-check"></span>${s}</li>`).join('');
            if (report.strengths.length === 0) strengthsHTML = '<li>نقطه قوت قابل توجهی یافت نشد.</li>';

            let weaknessesHTML = report.weaknesses.map(w => `<li><span class="icon-cross"></span>${w}</li>`).join('');
            if (report.weaknesses.length === 0) weaknessesHTML = '<li>نقطه ضعف قابل توجهی یافت نشد.</li>';

            card.innerHTML = `
                <div class="result-header">
                    <img src="${imgSrc}" alt="${filename}">
                    <div class="result-title">
                        <p class="filename">${filename}</p>
                        <span class="verdict ${verdictClass}">${report.verdict}</span>
                    </div>
                    <div class="quality-percent">${report.quality}%</div>
                </div>
                <div class="analysis-body">
                    <div class="analysis-list strengths">
                        <h4>نقاط قوت</h4>
                        <ul>${strengthsHTML}</ul>
                    </div>
                    <div class="analysis-list weaknesses">
                        <h4>نقاط ضعف</h4>
                        <ul>${weaknessesHTML}</ul>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(card);
        });
    }
    </script>
</body>
</html>
